import glob
import os.path
from conan import ConanFile
from conan.tools.build import check_min_cppstd
from conan.tools.files import (
    copy,
    rmdir,
    save,
)
from conan.tools.scm import Git

class Boost{{ project.name.title() | replace('-', '') | replace('_', '') }}Recipe(ConanFile):
    name = 'boost-{{project.name}}'

    license = 'BSL-1.0'
    description = '''{{project.description}}'''
    {% set sep = joiner(', ') -%}
    author = '{% for a in project.authors %}{{sep()}}{{a}}{% endfor %}'
    url = '{{project.url}}'
    topics = {{project.category}}

    python_requires = '{{ project.recipe_tools.conan_ref }}'
    {% if project.headeronly -%}
    package_type = 'header-library'
    {%- if project.cxxstd is defined %}
    settings = 'compiler'
    {%- endif %}
    {%- else %}
    package_type = 'library'
    settings = 'os', 'compiler', 'build_type', 'arch'
    options = {'shared': [True, False]}
    default_options = {'shared': False}
    {%- endif %}

    {% if project.cxxstd is defined -%}
    def validate(self):
        check_min_cppstd(self, '{{project.cxxstd}}')
    {%- endif %}

    def requirements(self):
        for dep in self.conan_data['sources'][self.version]['dependencies']:
            self.requires(
                dep,
                headers=True,
                transitive_headers=True,
            {%- if not project.headeronly %}
                libs=True,
                transitive_libs=True,
            {% endif -%}
            )

    def build_requirements(self):
       self.tool_requires('b2/[>={{ project.recipe_tools.b2_version }}]')

    def layout(self):
        self.folders.build = 'bin.v2'
        self.folders.generators = 'bin.v2/generators'

    def source(self):
        git = Git(self)
        data = self.conan_data['sources'][self.version]
        git.fetch_commit(data['url'], data['commit'])
        rmdir(self, '.git')

        if not glob.glob(f'{self.source_folder}/LICENSE*'):
            copy(
                self,
                'LICENSE_1_0.txt',
                self.python_requires['{{ project.recipe_tools.conan_name }}'].path,
                self.source_folder,
            )

    def generate(self):
        b2_gens = self.python_requires['{{ project.recipe_tools.conan_name }}'].module

        tc = b2_gens.B2Toolchain(self)
        tc.generate()

        deps = b2_gens.B2Deps(self)
        deps.generate()

        save(
            self,
            os.path.join(self.generators_folder, 'conanboost.jam'),
            _boost_install,
        )

    def build(self):
        b2 = self.python_requires['{{ project.recipe_tools.conan_name }}'].module.B2(self)
        b2.build('boost_{{project.name}}')

    def package(self):
        b2 = self.python_requires['{{ project.recipe_tools.conan_name }}'].module.B2(self)
        b2.build(target='conan-install')

    def package_info(self):
        self.cpp_info.set_property('cmake_target_name', 'Boost::{{project.name.title()}}')
        self.cpp_info.set_property('b2_target_name', '/boost/{{project.name}}//boost_{{project.name}}')

        {% if project.headeronly -%}
        self.cpp_info.bindirs = []
        self.cpp_info.libdirs = []
        {%- else -%}
        self.cpp_info.libs = ['boost_{{project.name}}']
        self.cpp_info.defines = ['BOOST_{{project.name | upper}}_NO_LIB=1']
        {%- endif %}
        self.cpp_info.resdirs = ['share']
        self.cpp_info.builddirs = ['share/boost/{{project.name}}/modules']

    {%- if project.headeronly %}
    def package_id(self):
        self.info.clear()
    {%- endif -%}


{% raw %}
_boost_install = '''\
# Conan automatically generated config file
# DO NOT EDIT MANUALLY, it will be overwritten

import notfile ;
import project ;
import targets ;

rule conan-install ( libraries * )
{
    local p = [ project.current ] ;
    if [ $(p).has-alternative-for-target conan-install ]
    {
        return ;
    }

    if $(libraries)
    {
        install conan-install-libraries-unchecked
            : $(libraries)
            : <location>(libdir)
              <install-dependencies>on
              <install-type>STATIC_LIB
              <install-type>SHARED_LIB
              <install-type>PDB
            ;
        $(p).mark-target-as-explicit conan-install-libraries-unchecked ;
        targets.create-metatarget check-files-target-class
            : $(p)
            : conan-install-libraries
            : conan-install-libraries-unchecked
            : <action>@check-files-installed
            ;
    }
    else
    {
        alias conan-install-libraries ;
    }
    $(p).mark-target-as-explicit conan-install-libraries ;

    install conan-install-headers
        : [ glob-tree-ex include : *.* ]
        : <location>(includedir)
          <install-source-root>include
        ;
    $(p).mark-target-as-explicit conan-install-headers ;

    local id = [ $(p).get id ] ;
    install conan-install-license
        : [ glob LICENSE* ]
        : <location>"(datarootdir)$(id)"
        ;
    $(p).mark-target-as-explicit conan-install-license ;

    install conan-install-jam
        : [ glob *.jam : build.jam ]
          [ glob-tree-ex checks check tools : *.* ]
        : <location>"(datarootdir)$(id)/modules"
          <install-source-root>.
        ;
    $(p).mark-target-as-explicit conan-install-jam ;

    alias conan-install
        : conan-install-libraries
          conan-install-headers
          conan-install-license
          conan-install-jam
        ;
    $(p).mark-target-as-explicit conan-install ;
}

rule check-files-installed ( tgt : files * : props * )
{
    if ! $(files)
    {
        import errors ;
        errors.user-error No binaries were installed. ;
    }
}

rule boost-library ( id ? : options * : * )
{
    for n in 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19
    {
        local option = $($(n)) ;
        if $(option[1]) = install
        {
            conan-install $(option[2-]) ;
            if $(option[1]) = install
            {
                called-conan-install = true ;
            }
        }
        if ! $(called-conan-install)
        {
            conan-install ;
        }
    }
}

class check-files-target-class : make-target-class
{
    rule skip-from-usage-requirements ( ) { }
}

'''
{% endraw %}
