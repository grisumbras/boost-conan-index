name: CI

on:
  push:
  schedule:
    - cron: '0 11 * * 1,3'

permissions:
  contents: read

defaults:
  run:
    shell: bash

jobs:
  Generate:
    runs-on: ubuntu-latest

    strategy:
      matrix:
        boost-ref:
          - develop
          - master
          - boost-1.89.0

    steps:
      - name: Fetch head
        uses: actions/checkout@v5

      - name: Install dependencies
        run: pip install -r requirements.txt

      - name: Generate index
        run: ./generate.py --ref  ${{ matrix.boost-ref }} --target index

      - name: Setup Conan
        run: conan profile detect

      - name: Test selected packages
        run: |
          set -ex

          conan remote add boost-conan-index ./index

          ANY_VERSION=`python <<EOF
          import yaml
          with open("index/recipes/boost-any/config.yml", "r") as f:
            cfg = yaml.load(f, yaml.Loader)
            version = next(iter(cfg["versions"]))
            print(version)
          EOF`
          conan test --build=missing \
            index/recipes/boost-any/all/test_package boost-any/$ANY_VERSION

      - name: Save index
        uses: actions/upload-artifact@v4
        with:
          name: index-${{ matrix.boost-ref }}
          path: |
            index/
            !**/build/
          if-no-files-found: error
          retention-days: 1
          compression-level: 9

  Merge:
    runs-on: ubuntu-latest
    needs: Generate
    permissions:
      contents: write
    steps:

      - name: Fetch head
        uses: actions/checkout@v5
        with:
          path: head

      - name: Fetch current index
        uses: actions/checkout@v5
        with:
          ref: index
          path: current-index

      - name: Download new indices
        uses: actions/download-artifact@v5
        with:
          pattern: index-*

      - name: Update index
        run: |
          set -ex

          for dir in index-*; do
            head/merge-index.py $dir current-index
          done
          cp head/README.adoc current-index

      - name: Uploading updated index
        if: (github.event_name == 'push' && github.ref == 'refs/heads/master') || github.event_name == 'schedule'
        env:
          GIT_AUTHOR_NAME: ${{ github.triggering_actor }}
          GIT_AUTHOR_EMAIL: ${{ github.triggering_actor }}@users.noreply.github.com
          GIT_COMMITTER_NAME: ${{ github.triggering_actor }}
          GIT_COMMITTER_EMAIL: ${{ github.triggering_actor }}@users.noreply.github.com
          COMMIT_MESSAGE: ${{ (github.event_name == 'schedule' && 'Scheduled update') || 'Automatic update due to a push to master' }}
        run: |
            set -ex

            git -C current-index add .
            git -C current-index commit -m "$COMMIT_MESSAGE"
            git -C current-index push
